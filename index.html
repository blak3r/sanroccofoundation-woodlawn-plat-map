<!-- SweetAlert2 (MIT, 12 kB gzipped) -->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<style>
    /* 2‑a  Bigger pin labels on small screens */
    @media (max-width: 768px){
        .leaflet-popup-content{
            font-size: 1.1rem;      /* ≈17‑18 px */
            line-height: 1.35;
        }
    }

    /* 2‑b  Make sure SweetAlert’s text input has a visible border in iOS */
    .swal2-input{
        border: 1px solid #aaa !important;
    }
</style>


<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<h2>Aliquippa Woodlawn Plat Map</h2>
<p>This is an interactive map.  Click on one of the blue markers to see which family lived at that parcel.  Want to add your family? Simply click on the map and fill in the name.  Your changes will be saved an immediately viewable to others.</p>
If you make a mistake, please email <a href="mailto:sanroccofoundation@gmail.com">sanroccofoundation@gmail.com</a> and indicate the family name you entered and we'll update it!</p>
<div id="platMap" style="width:100%;height:85%;"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const IMG_URL  = 'https://images.squarespace-cdn.com/content/59f8e7d551a584524dbcff39/4b184372-574a-43c1-abcc-57253fd9cab5/platmap_woodlawn_1923_3300.png?content-type=image%2Fpng';
    const IMG_W    = 3300;   // image width  px
    const IMG_H    = 3795;   // image height px
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbypc_NZYMZ7R_4bUbbK4I80sjjq-5tlRvPIN2HIfIYTeBu-9bSAWyu76XT937RDgYzs/exec';

    /* 1. Build a Leaflet map that treats pixels as coordinates */
    const map = L.map('platMap', {crs: L.CRS.Simple, minZoom:-2});
    const bounds = [[0,0],[IMG_H,IMG_W]];
    L.imageOverlay(IMG_URL, bounds).addTo(map);
    map.fitBounds(bounds);

    // --- 1.  READ existing pins via JSONP ------------------------------
    function loadPins() {
        // Each call gets a unique cache‑buster
        const url = `${SCRIPT_URL}?callback=renderPins&_=${Date.now()}`;
        const tag = document.createElement('script');
        tag.src = url;
        document.body.appendChild(tag);
    }

    function addMarker({x, y, name}) {
        L.marker([y,x]).addTo(map).bindPopup(`<strong>${name}</strong>`);
    }

    // This is the global callback Apps Script will call
    function renderPins(rows) {
        rows.forEach(addMarker);     // your existing addMarker() function
    }

    // Call it once on page load
    loadPins();

    /* -----------------------------------------------------------------------
       3‑a  Disable map’s own double‑click‑zoom so we can use dbl‑click for pins
        ------------------------------------------------------------------------ */
    //map.doubleClickZoom.disable();

    map.on('click', e => {
        Swal.fire({
            title: 'Want to add your family?',
            text: 'Fill in the name below and click Add Pin.  It\'ll then be live on the site!',
            input: 'text',
            inputPlaceholder: 'Name or family',
            showCancelButton: true,
            confirmButtonText: 'Add pin',
            inputValidator: value => !value.trim() && 'Please enter a name'
        }).then(result => {
            if (!result.isConfirmed) return;           // user hit “Cancel”

            const name = result.value.trim();
            const { lat: y, lng: x } = e.latlng;

            addMarker({ name, x, y });                 // optimistic UI

            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // CORS‑safe
                body: JSON.stringify({ name, x, y })
            });
        });
    });
</script>

